# Sync a solution to the given output directory

parameters:
  # ----- Required parameters -----

  # The unique name of the solution
  - name: solutionUniqueName
    displayName: Solution unique name
    type: string

  # ----- Optional predefined parameters -----

  # Path to the repository folder to sync to
  - name: outputDirectory
    displayName: Path to folder where solutions should be synced to
    type: string
    default: $(Build.Repository.LocalPath)/solutions

  # Option to overwrite the condition for this task
  - name: condition
    displayName: Overwrite condition for task
    type: string
    default: succeeded()

steps:
  # Sync solution
  - task: PowerShell@2
    displayName: Sync solution
    condition: ${{ parameters.condition }}
    inputs:
      targetType: inline
      workingDirectory: ${{ parameters.outputDirectory }}/${{ parameters.solutionUniqueName }}
      script: |
        $Debug = $env:Debug
        $SolutionUniqueName = $env:SolutionUniqueName
        $WorkingDirectory = $env:WorkingDirectory
        $ProcessCanvasApps = $env:ProcessCanvasApps

        if ($Debug -eq $True) {
          Write-Host "##[debug]SolutionUniqueName=$SolutionUniqueName"
          Write-Host "##[debug]WorkingDirectory=$WorkingDirectory"
          Write-Host "##[debug]ProcessCanvasApps=$ProcessCanvasApps"
        }

        $parameter = @(
          "--async",
          "--packagetype", "Both"
        )

        if ($ProcessCanvasApps -eq $True) {
          $parameter += "--processCanvasApps"
        }

        Write-Host "##[group]Syncing solution $SolutionUniqueName"
        & pac solution sync @parameter
        Write-Host "##[endgroup]"
    env:
      Debug: $(System.Debug)
      SolutionUniqueName: ${{ parameters.solutionUniqueName }}
      WorkingDirectory: ${{ parameters.outputDirectory }}
      ProcessCanvasApps: $[ coalesce(variables.SolutionConfigProcessCanvasApps_Export, 'true') ]